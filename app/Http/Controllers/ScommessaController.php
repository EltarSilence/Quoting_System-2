<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Input;
use App\Multipla;
use App\Scommessa;
use App\User;
use App\Disponibili;

class ScommessaController extends Controller
{

  public function myBet(){
      $userBets = ScommessaController::getAllBetsBy(1);
      $vincite = array();
      $dettagli = array();

      foreach($userBets as $bet){
        $won = ScommessaController::isWon($bet);
        $details = ScommessaController::getBetDetail($bet);
        array_push($vincite, $won);
        array_push($dettagli, $details);
      }

      return view('my-bet')
        ->with('userBets', $userBets)
        ->with('isWon', $vincite)
        ->with('details', $dettagli);
  }

  public function scommetti(){
    $verifiche = ScommessaController::getDisponibili();
    return view('scommetti');
  }

  public static function getDisponibili(){
    $verifiche = Disponibili::select('alD', 'fileD', 'descrizioneD')
    ->whereDate('dalD', '<=', date('Y-m-d'))
    ->whereDate('alD', '>=', date('Y-m-d'))
    ->get();
    $ret = array();
    foreach ($verifiche as $v) {
      $a = array();
      $a['alD'] = $v->alD;
      $a['type'] = substr($v->fileD, 0, stripos($v->fileD, "_"));
      $a['fileD'] = $v->fileD;
      $a['descrizioneD'] = explode("|", $v->descrizioneD);

      array_push($ret, $a);
    }

    return $ret;
  }

  public static function getScommessa(){
    $key = Input::get('scommessa');

    $scom = Disponibili
      ::where('fileD', '=', $key)
      ->get();

    $data = array();
    $data['type'] = substr($key, 0, stripos($key, "_"));
    $data['descrizione'] = explode("|", $scom[0]->descrizioneD);
    $data['al'] = date("d/m/Y", strtotime($scom[0]->alD));
    $data['filename'] = $key;
    $data['file'] = json_decode('{"Andreoli":{"ESATTO":{"10.0":8.08,"9.5":2.0931263274277,"9.0":5.4179231640202,"8.5":1.558216265974,"8.0":4.0333427998817,"7.5":1.3050061227532,"7.0":3.3779245949009,"6.5":1.2490772889209,"6.0":3.2331563979766,"5.5":1.3948029726284,"5.0":3.6103579777405,"4.5":1.869035983322,"4.0":4.8378796901723,"3.5":3.1306352720644,"3.0":8.1034484810387,"2.0":18.097701607653,"1.0":60.627300385638},"UNDER":{"10.0":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3.0":10.120641548659,"2.0":26.949936147538},"OVER":{"10.0":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3.0":1,"2.0":1}},"Bacchetti":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Bara":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Canipari":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Cavedaghi":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Conzadori":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Deambrosis":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Gallina":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Marchi":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Ottolini":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Ravasi":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Rizza":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}},"Siliqua":{"ESATTO":{"10":8.0864524836123,"9.5":2.0931263274277,"9":5.4179231640202,"8.5":1.558216265974,"8":4.0333427998817,"7.5":1.3050061227532,"7":3.3779245949009,"6.5":1.2490772889209,"6":3.2331563979766,"5.5":1.3948029726284,"5":3.6103579777405,"4.5":1.869035983322,"4":4.8378796901723,"3.5":3.1306352720644,"3":8.1034484810387,"2":18.097701607653,"1":60.627300385638},"UNDER":{"10":1,"9.75":1.1633725130506,"9.25":1.1633725130506,"8.75":1.303299033402,"8.25":1.303299033402,"7.75":1.5544436861289,"7.25":1.5544436861289,"6.75":2.0189902729389,"6.25":2.0189902729389,"5.75":2.9355691136071,"5.25":2.9355691136071,"4.75":4.9466007862103,"4.25":4.9466007862103,"3.75":10.120641548659,"3.25":10.120641548659,"3":10.120641548659,"2":26.949936147538},"OVER":{"10":"-","9.75":"-","9.25":5.1271061071148,"8.75":3.0938948058092,"8.25":3.0938948058092,"7.75":2.018598970487,"7.25":2.018598970487,"6.75":1.4265818184146,"6.25":1.4265818184146,"5.75":1.0919836170863,"5.25":1.0919836170863,"4.75":1,"4.25":1,"3.75":1,"3.25":1,"3":1,"2":1}}}', true);

    return $data;
  }

  public static function getWeekWin(){
    $ret = array();
    $scom = Scommessa
    ::join('users', 'users.id', '=', 'scommessas.idUtenteS')
    ->whereDate('dataS', '>=', date("Y-m-d", strtotime(date("Y-m-d")."-7day")))
    ->where('pagataS', 1)
    ->get();
    foreach ($scom as $s) {
      $winCoin = ScommessaController::isWon($s);
      if($winCoin > 0){
        array_push($ret, array($s->name => $winCoin));
      }
    }
    usort($ret, "self::cmp");
    return $ret;
  }

  public static function getMouthWin(){
    $ret = array();
    $scom = Scommessa
    ::join('users', 'users.id', '=', 'scommessas.idUtenteS')
    ->whereDate('dataS', '>=', date("Y-m-d", strtotime(date("Y-m-d")."-30day")))
    ->where('pagataS', 1)
    ->get();

    foreach ($scom as $s) {
      $winCoin = ScommessaController::isWon($s);
      if($winCoin > 0){
        array_push($ret, array($s->name => $winCoin));
      }
    }
    usort($ret, "self::cmp");
    return $ret;
  }

  public static function cmp($a, $b){
    foreach($a as $akey => $avalue){
      foreach($b as $bkey => $bvalue){
        return ($avalue < $bvalue) ? 1 : -1;
      }
    }
    return 0;
  }

  private static function isWon($scommessa){
    $vin = 1;
    $mult = Multipla
      ::leftJoin('risultatis', 'multiplas.chiaveM', '=', 'risultatis.chiaveR')
      ->where('idScommessaM', '=', $scommessa->idS)
      ->get();
    foreach ($mult as $m) {
      if (!isset($m->chiaveR)){
        return -1;
      }
      $chiave = explode('_', $m->chiaveR);
      $tipo = $chiave[0];
      switch ($tipo) {
        case 'EUO':
          $cat = $m->tipoM;
          switch ($cat){
            case 'ESATTO':
            if ($m->valueM == $m->risultatoR){
              $vin = $vin*$m->quotaM;
            }
            else {
              return 0;
            }
            break;
            case 'UNDER':
            $value = floatval($m->valueM);
            $res = floatval($m->risultatoR);

            if ($res < $value) {
              $vin *= $m->quotaM;
            }
            else {
              return 0;
            }
            break;
          case 'OVER':
            $value = floatval($m->valueM);
            $res = floatval($m->risultatoR);

            if ($res > $value) {
              $vin *= $m->quotaM;
            }
            else {
              return 0;
            }
            break;
          default:
            return 0;
            break;
        }
        break;
        case 'SN':
        case 'MT':
        if ($m->risultatoR == $m->valueM){
          $vin = $vin*$m->quotaM;
        }
        else {
          return 0;
        }
        break;

        default:
        return 0;
        break;
      }
    }
    return $vin*$scommessa->coinS;
  }

  public static function getAllBetsBy($id){
    $bets = Scommessa::where('idUtenteS', '=', $id)
    ->orderBy('dataS', 'desc')
    ->get();
    return $bets;
  }

  public static function getBetDetail($scommessa){
    $mult = Multipla
      ::leftJoin('risultatis', 'multiplas.chiaveM', '=', 'risultatis.chiaveR')
      ->join('disponibilis', 'multiplas.chiaveM', 'LIKE', DB::raw('CONCAT(disponibilis.fileD, "%")'))
      ->where('idScommessaM', '=', $scommessa->idS)
      ->get();
    return $mult;

  }

}
